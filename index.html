<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Library Loan System</title>

<style>
    * { box-sizing: border-box; }

    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: url('Background.jpg') no-repeat center center fixed;
        background-size: cover;
        color: white;
    }

    .overlay-box {
        background: rgba(0,0,0,0.55);
        padding: 20px;
        border-radius: 14px;
        width: 90%;
        max-width: 480px;
        margin: 20px auto;
        text-align: center;
    }

    input, select, button {
        width: 100%;
        padding: 14px;
        margin-top: 12px;
        border-radius: 10px;
        border: none;
        font-size: 18px;
    }

    button {
        cursor: pointer;
        background: #8AAA AF; /* Your chosen colour */
        color: white;
        font-size: 20px;
        font-weight: bold;
    }

    button:hover {
        opacity: 0.9;
    }

    #reader {
        width: 100%;
        max-width: 100%;
        height: auto;
        margin-bottom: 15px;
    }

    #summary-screen {
        display: none;
    }

    #summaryCover {
        margin-top: 12px;
        max-width: 180px;
        border-radius: 8px;
        box-shadow: 0 0 8px rgba(0,0,0,0.7);
        display: none;
    }

    @media (orientation: landscape) {
        .overlay-box { max-width: 600px; }
        input, select, button { font-size: 16px; }
    }
</style>
</head>

<body>

<!-- MAIN INPUT SCREEN -->
<div id="scan-screen" class="overlay-box">
    <h2>Library Book Loan / Return</h2>

    <!-- CAMERA LIVE SCANNER -->
    <div id="reader"></div>

    <input id="barcodeInput" placeholder="Or scan/type barcode here..." />

    <h3>Action</h3>
    <select id="actionSelect">
        <option value="">Choose...</option>
        <option value="loan">Loan Out</option>
        <option value="return">Return</option>
    </select>

    <h3>Form</h3>
    <select id="formSelect">
        <option value="">Choose form...</option>
        <option value="Form 8">Form 8</option>
        <option value="Form 7">Form 7</option>
        <option value="Form 6">Form 6</option>
        <option value="Form 5">Form 5</option>
        <option value="Form 4">Form 4</option>
        <option value="Form 3">Form 3</option>
    </select>

    <h3>Name (Initials)</h3>
    <select id="initialsSelect">
        <option value="">Choose initials...</option>
    </select>

    <button onclick="processScan()">Continue</button>
</div>

<!-- SUMMARY SCREEN -->
<div id="summary-screen" class="overlay-box">
    <h2>Loan Summary</h2>
    <p id="summaryForm"></p>
    <p id="summaryName"></p>
    <p id="summaryBook"></p>
    <p id="summaryAuthor"></p>
    <p id="summaryStatus"></p>
    <p id="summaryDate"></p>
    <p id="summaryLoanDate"></p>
    <p id="summaryReturnDate"></p>

    <img id="summaryCover" src="">

    <button onclick="resetForm()">Scan Another Book</button>
</div>

<!-- CAMERA SCANNER LIBRARY -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* -----------------------------------------
   FORM → INITIALS DATA
----------------------------------------- */
const formStudents = {
    "Form 8": ["JC","ADB","CG","JG","RH","KH","AL","LLV","WN","IO","MP","HP","Ase","Ast","ST","AT","CW"],
    "Form 7": ["DAB","EC","TE","DE-S","PH-S","CH","NJ","LLFP","TM","LP","SS","AS","TS"],
    "Form 6": ["MA","EC","MH","PM","AP","MT"],
    "Form 5": ["PC","GH","CH","SH","EL","MM","RM","PS","OS","MT","AT","TW","BW"],
    "Form 4": ["AWAM","BC","HD","NN","ZJ","LN","PP","KP","NS","GSP","BT"],
    "Form 3": ["PA","PC","WH","BH"]
};

const formSelect = document.getElementById("formSelect");
const initialsSelect = document.getElementById("initialsSelect");

formSelect.addEventListener("change", () => {
    const formName = formSelect.value;
    initialsSelect.innerHTML = `<option value="">Choose initials...</option>`;
    if (!formName) return;

    formStudents[formName].forEach(initials => {
        const opt = document.createElement("option");
        opt.value = initials;
        opt.textContent = `${initials} (${formName})`;
        initialsSelect.appendChild(opt);
    });
});

/* -----------------------------------------
   CAMERA SCANNER – REAR CAMERA
----------------------------------------- */
let html5QrCode;

async function startCameraScanner() {
    const cameras = await Html5Qrcode.getCameras();
    
    if (!cameras || cameras.length === 0) {
        alert("No camera found.");
        return;
    }

    // Prefer REAR camera if available
    let rearCamera = cameras.find(c => 
        c.label.toLowerCase().includes("back") ||
        c.label.toLowerCase().includes("rear")
    );

    const cameraId = rearCamera ? rearCamera.id : cameras[0].id;

    if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: { width: 260, height: 160 } },
        decodedText => {
            document.getElementById("barcodeInput").value = decodedText;
            html5QrCode.stop();
        }
    );
}

window.onload = startCameraScanner;

/* -----------------------------------------
   GOOGLE BOOKS LOOKUP
----------------------------------------- */
async function lookupBookFromISBN(isbn) {
    try {
        const res = await fetch(
            `https://www.googleapis.com/books/v1/volumes?q=isbn:${encodeURIComponent(isbn)}`
        );
        const data = await res.json();
        if (!data.items) return { title: "Unknown", author: "Unknown", cover: "" };

        const info = data.items[0].volumeInfo;

        return {
            title: info.title || "Unknown",
            author: info.authors ? info.authors[0] : "Unknown",
            cover: info.imageLinks ? info.imageLinks.thumbnail : ""
        };
    } catch {
        return { title: "Unknown", author: "Unknown", cover: "" };
    }
}

/* -----------------------------------------
   PROCESS LOAN / RETURN
----------------------------------------- */
let loanRecords = {};

async function processScan() {
    const barcode = document.getElementById("barcodeInput").value.trim();
    const action = document.getElementById("actionSelect").value;
    const formName = formSelect.value;
    const initials = initialsSelect.value;

    if (!barcode || !action || !formName || !initials) {
        alert("Complete all fields.");
        return;
    }

    const today = new Date().toLocaleDateString();

    const book = await lookupBookFromISBN(barcode);

    if (action === "loan") {
        loanRecords[barcode] = {
            initials, formName, loan: today, return: ""
        };
    } else {
        if (!loanRecords[barcode]) {
            loanRecords[barcode] = { initials, formName, loan: "Unknown", return: today };
        } else {
            loanRecords[barcode].return = today;
        }
    }

    showSummary(book, action, formName, initials, loanRecords[barcode]);
}

/* -----------------------------------------
   SUMMARY PAGE
----------------------------------------- */
function showSummary(book, action, formName, initials, record) {
    document.getElementById("scan-screen").style.display = "none";
    document.getElementById("summary-screen").style.display = "block";

    document.getElementById("summaryForm").innerHTML = `<strong>Form:</strong> ${formName}`;
    document.getElementById("summaryName").innerHTML = `<strong>Name:</strong> ${initials}`;
    document.getElementById("summaryBook").innerHTML = `<strong>Book:</strong> ${book.title}`;
    document.getElementById("summaryAuthor").innerHTML = `<strong>Author:</strong> ${book.author}`;
    document.getElementById("summaryStatus").innerHTML = `<strong>Status:</strong> ${action}`;
    document.getElementById("summaryDate").innerHTML = `<strong>Today:</strong> ${new Date().toLocaleDateString()}`;
    document.getElementById("summaryLoanDate").innerHTML = `<strong>Date Loaned:</strong> ${record.loan}`;
    document.getElementById("summaryReturnDate").innerHTML = `<strong>Date Returned:</strong> ${record.return || "—"}`;

    const img = document.getElementById("summaryCover");
    if (book.cover) {
        img.src = book.cover;
        img.style.display = "block";
    } else {
        img.style.display = "none";
    }
}

/* -----------------------------------------
   RESET
----------------------------------------- */
function resetForm() {
    document.getElementById("scan-screen").style.display = "block";
    document.getElementById("summary-screen").style.display = "none";

    document.getElementById("barcodeInput").value = "";
    document.getElementById("actionSelect").value = "";
    formSelect.value = "";
    initialsSelect.innerHTML = `<option value="">Choose initials...</option>`;

    startCameraScanner();
}
</script>

</body>
</html>
