<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ST PHILIP'S LIBRARY BOOK LOAN/RETURN</title>

<style>
* { box-sizing:border-box; font-family:Arial, sans-serif; }
body {
    margin:0; background:url('Background.jpg') no-repeat center center fixed;
    background-size:cover; color:white;
}
.page { min-height:100vh; display:flex; justify-content:center; align-items:center; padding:16px; }
.overlay-box {
    background:rgba(0,0,0,0.55); padding:20px; border-radius:14px;
    max-width:480px; width:100%; text-align:center; animation:fadeIn .5s ease;
}
@keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }

button, select {
    width:100%; padding:14px; margin-top:12px; border-radius:10px; border:none;
    font-size:18px; font-weight:bold; cursor:pointer; transition:.2s;
}
button { background:white; color:black; text-transform:uppercase; }
button:hover { transform:scale(1.03); opacity:.9; }
button:active { transform:scale(.97); }

input {
    width:100%; padding:12px; border-radius:10px; border:none; font-size:16px; margin-top:10px;
}

.book-card {
    background:rgba(255,255,255,0.15); padding:12px; border-radius:12px; margin-top:10px;
    display:flex; gap:10px; align-items:center;
}
.book-card img { width:60px; height:90px; object-fit:cover; border-radius:6px; }

#detailCover,#summaryCover { max-width:180px; margin:10px auto; border-radius:8px; }

#detail-screen,#form-screen,#summary-screen,#who-screen { display:none; }

#copiesInfo { margin-top:10px; text-align:left; font-size:15px; }
#suggestions { margin-top:10px; }

</style>
</head>

<body>
<div class="page">

<!-- START SCREEN -->
<div id="scan-screen" class="overlay-box">
    <h1>ST PHILIP'S LIBRARY BOOK LOAN/RETURN</h1>

    <button id="startScanButton">SCAN BAR CODE HERE</button>
    <button id="manualTitleButton">SEARCH TITLE MANUALLY</button>
    <button id="whoHasButton">WHO HAS THIS BOOK?</button>

    <div id="manualTitleArea" style="display:none; margin-top:10px;">
        <input id="manualTitleInput" type="text" placeholder="Start typing a book title…">
        <div id="suggestions"></div>
    </div>

    <div id="reader"></div>
</div>
<!-- =======================
     BOOK DETAIL SCREEN
======================== -->
<div id="detail-screen" class="overlay-box">

    <h2 id="detailTitle"></h2>
    <p id="detailAuthor"></p>
    <img id="detailCover">

    <p id="detailWordCount"></p>

    <!-- This will show the list of all copies by location -->
    <div id="copiesInfo"></div>

    <button id="signOutButton">SIGN THIS BOOK OUT</button>
    <button id="returnButton">RETURN THIS BOOK</button>
    <button id="backToResultsButton">BACK</button>
</div>


<!-- =======================
     FORM SCREEN
======================== -->
<div id="form-screen" class="overlay-box">
    <h2>Complete Your Details</h2>

    <h3>Form</h3>
    <select id="formSelect">
        <option value="">Select Form…</option>
        <option value="Form 3">Form 3</option>
        <option value="Form 4">Form 4</option>
        <option value="Form 5">Form 5</option>
        <option value="Form 6">Form 6</option>
        <option value="Form 7">Form 7</option>
        <option value="Form 8">Form 8</option>
    </select>

    <h3>Initials</h3>
    <select id="initialsSelect">
        <option value="">Select Initials…</option>
    </select>

    <!-- Location field used for returns (where they place the book back) -->
    <h3 id="locationLabel">Location</h3>
    <select id="locationSelect">
        <option value="">Select Location…</option>
        <option value="Big School Room">Big School Room</option>
        <option value="Form 3">Form 3</option>
        <option value="Form 4">Form 4</option>
        <option value="Form 5">Form 5</option>
        <option value="Form 6">Form 6</option>
        <option value="Form 7">Form 7</option>
        <option value="Form 8">Form 8</option>
    </select>

    <button id="formContinueBtn">CONTINUE</button>
    <button id="formBackBtn">BACK</button>
</div>
<!-- ==========================
     WHO HAS THIS BOOK SCREEN
========================== -->
<div id="who-screen" class="overlay-box">
    <h2>Who Has This Book?</h2>

    <input id="whoQueryInput" type="text" placeholder="Enter title…">
    <button id="whoSearchButton">SEARCH</button>

    <div id="whoResults" style="margin-top:15px; text-align:left; font-size:14px;"></div>

    <button id="whoBackButton">BACK</button>
</div>


<!-- ==========================
     SUMMARY SCREEN
========================== -->
<div id="summary-screen" class="overlay-box">
    <h2>Summary</h2>

    <p id="summaryForm"></p>
    <p id="summaryInitials"></p>
    <p id="summaryLocation"></p>
    <p id="summaryBook"></p>
    <p id="summaryAuthor"></p>
    <p id="summaryAction"></p>
    <p id="summaryDate"></p>
    <p id="summaryLoan"></p>
    <p id="summaryReturn"></p>

    <img id="summaryCover">

    <!-- BUTTON ONLY SHOWN FOR RETURNS -->
    <button id="arButton" style="display:none; margin-top:10px;">
        LOG YOUR WORD COUNT ON ACCELERATED READER
    </button>

    <button onclick="resetForm()" style="margin-top:10px;">
        Scan Another Book
    </button>
</div>
<!-- OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- Camera scanning -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ================================================================
   CONFIG
================================================================ */

const SHEET_URL =
  "https://script.google.com/macros/s/AKfycbzzx-KWXfCV9vWJG5RIq8nLBvNU3jWB3IYZ9jys5uz3d8vHIKYDB-PsZHbF5AVcBLGWmQ/exec";

const AR_URL =
  "https://global-zone08.renaissance-go.com/identityservice/sso/tenant?returnUrl=%2Fidentityservice%2Fsso%2Fconnect%2Fauthorize%2Fcallback%3Fclient_id%3Dstudentportallinux%26redirect_uri%3Dhttps%253A%252F%252Fglobal-zone08.renaissance-go.com%252Fstudentportal%252Fsignin-oidc%26response_type%3Did_token%26scope%3Dopenid%2520ren.profile%26response_mode%3Dform_post%26nonce%3D639008158509953001.Y2Q0NWIxYmQtNGI1MC00ZWRmLWIwN2YtZDAzNzJmYWZmMTcxOTY2NGExYmQtMDAwMy00NGFjLWIzZTQtN2MyYzI0M2Y1N2Yy%26prompt%3Dlogin%26state%3DCfDJ8DPUwk2T_CRBtvGzYEDp-ve75Wt-t6h_dPHlpD6RnyS_miIEHX4NCYeQWQW-BFY1nDasGpzBbaZMwG0tmr_2TNqvcfRpAwE7ygBjeP9fB23tHENoHcn-vLmEBHD0KWtQnFmpvUmAB3jsNNylvjBRcqdtISMOn4lp5mcQP8A2-S-ShyEmdT57JktdEHm1TfI0w5qdh5dqMqEWzfKXfVA08AZsSSBPCwpYL-8JC0ED0Q0nPjZsaeJxasMV54P2Py_tMdPPr9wJ_mB9jBfaHDit0Wg4ZlIJv-_pNWBVztTAGXMPjfApo4XGX8QW4ZeJt8Q9zHTJriFVJt9wjmrPpF3N2OqO6td351RCZEd0lMPzLlq94Ma_Ppi3C5ZCUYqA-KAuOspYRLwIBMOVYbgto2VyvloWMUNofRgpBXafKGuAe3LepQq98jK31EMiFQ4JJIrR7Q%26x-client-SKU%3DID_NETSTANDARD2_0%26x-client-ver%3D6.8.0.0%26suppressed_prompt%3Dlogin";


/* ================================================================
   GLOBAL STATE
================================================================ */

let libraryBooks = [];
let googleCache = {};
let selectedBook = null;
let pendingAction = null;
let qrScanner = null;

/* ================================================================
   GOOGLE SHEET LOADING / POSTING
================================================================ */

async function fetchSheetData() {
    try {
        const res = await fetch(SHEET_URL);
        return await res.json();
    } catch (err) {
        console.error("Error loading sheet", err);
        return [];
    }
}

async function loadLibraryBooks() {
    const data = await fetchSheetData();
    libraryBooks = data.map(r => {
        const status = (r.Status || "").toLowerCase();
        const onLoan = status === "loan" && !r["Return Date"];
        return {
            title:    r.Title || "",
            author:   r.Author || "",
            location: r.Location || "",
            form:     r.Form || "",
            initials: r.Initials || "",
            loanDate: r["Loan Date"] || "",
            returnDate: r["Return Date"] || "",
            status: status,
            onLoan: onLoan
        };
    });
}
loadLibraryBooks();

async function postRecord(record) {
    try {
        await fetch(SHEET_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(record)
        });
        loadLibraryBooks();
    } catch (err) {
        console.error("Error posting record", err);
    }
}

/* ================================================================
   GOOGLE BOOKS LOOKUP (title search)
================================================================ */

async function lookupBook(query) {
    try {
        const res = await fetch(
            "https://www.googleapis.com/books/v1/volumes?q=" +
            encodeURIComponent(query)
        );
        const data = await res.json();

        if (!data.items) return { title: query, author: "Unknown", thumbnail: "" };

        const info = data.items[0].volumeInfo;
        return {
            title: info.title || query,
            author: (info.authors && info.authors[0]) || "Unknown",
            thumbnail: (info.imageLinks && info.imageLinks.thumbnail) || "",
            pageCount: info.pageCount || null
        };
    } catch {
        return { title: query, author: "Unknown", thumbnail: "" };
    }
}

/* ================================================================
   COVER CAPTURE MODE (front camera, full-screen)
================================================================ */

let videoStream = null;

async function startCoverCapture() {
    stopAllScanning();

    // Request FRONT camera
    const constraints = {
        video: {
            facingMode: "user",
            width: { ideal: 1280 },
            height: { ideal: 720 }
        }
    };

    try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoStream = stream;

        // Create dynamic preview
        const reader = document.getElementById("reader");
        reader.innerHTML = `
            <video id="coverVideo" autoplay playsinline style="width:100%; border-radius:10px;"></video>
            <button id="captureBtn" style="margin-top:10px;">CAPTURE</button>
        `;
        reader.style.display = "block";

        const video = document.getElementById("coverVideo");
        video.srcObject = stream;

        document.getElementById("captureBtn").onclick = async () => {
            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0);

            const dataURL = canvas.toDataURL("image/jpeg");

            await processCoverImage(dataURL);
        };

    } catch (err) {
        alert("Camera access blocked or unavailable.");
        console.error(err);
    }
}

async function processCoverImage(dataURL) {
    const reader = document.getElementById("reader");
    reader.innerHTML = "<p>Processing cover… please wait…</p>";

    // Run OCR
    const { data: { text } } = await Tesseract.recognize(
        dataURL,
        "eng",
        { logger: m => console.log(m) }
    );

    // Extract most likely title words
    const cleaned = text
        .replace(/\n/g, " ")
        .replace(/[^a-zA-Z0-9 ]/g, " ")
        .trim();

    if (!cleaned) {
        reader.innerHTML = "<p>Could not read any text on the cover.</p>";
        return;
    }

    const bestGuess = cleaned.split(" ").slice(0, 6).join(" "); // first 6 words

    const gb = await lookupBook(bestGuess);
    selectedBook = gb;

    showDetailScreen(gb);

    stopAllScanning();
}

/* ================================================================
   BARCODE SCANNER (rear camera optional)
================================================================ */

async function startBarcodeScanner() {
    stopAllScanning();

    try {
        const cams = await Html5Qrcode.getCameras();

        // prefer REAR camera for barcodes
        const cam = cams.find(c => 
            c.label.toLowerCase().includes("back")
        ) || cams[0];

        qrScanner = new Html5Qrcode("reader");
        document.getElementById("reader").style.display = "block";

        await qrScanner.start(
            cam.id,
            { fps: 10, qrbox: null },
            async (codeText) => {
                const gb = await lookupBook(codeText);
                selectedBook = gb;
                showDetailScreen(gb);
                stopAllScanning();
            }
        );

    } catch (err) {
        console.error(err);
        alert("Could not start barcode scanner.");
    }
}

function stopAllScanning() {
    document.getElementById("reader").style.display = "none";
    document.getElementById("reader").innerHTML = "";
    if (qrScanner) {
        try { qrScanner.stop(); } catch {}
        qrScanner = null;
    }
    if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
    }
}

/* ================================================================
   DETAIL SCREEN
================================================================ */

async function showDetailScreen(book) {
    stopAllScanning();

    selectedBook = book;

    document.getElementById("scan-screen").style.display = "none";
    document.getElementById("detail-screen").style.display = "block";

    document.getElementById("detailTitle").textContent = book.title;
    document.getElementById("detailAuthor").textContent = "Author: " + book.author;

    if (book.thumbnail) {
        detailCover.src = book.thumbnail;
        detailCover.style.display = "block";
    } else {
        detailCover.style.display = "none";
    }

    if (book.pageCount) {
        let wc = Math.round(book.pageCount * 275);
        detailWordCount.textContent = `Estimated: ~${wc.toLocaleString()} words`;
    } else {
        detailWordCount.textContent = "Estimated word count unavailable";
    }

    updateCopiesInfo(book);

    const data = await fetchSheetData();
    const t = book.title.toLowerCase();
    const matches = data.filter(r => (r.Title || "").toLowerCase() === t);
    const anyOnLoan = matches.some(r =>
        (r.Status || "").toLowerCase() === "loan" && !r["Return Date"]
    );

    returnButton.style.display = anyOnLoan ? "block" : "none";
}

/* (Loan/Return functions unchanged from previous version) — already included in earlier answer */

/* ================================================================
   BUTTON WIRING
================================================================ */

document.getElementById("startScanButton").onclick = startBarcodeScanner;

const coverBtn = document.createElement("button");
coverBtn.textContent = "CAPTURE BOOK COVER";
coverBtn.style.marginTop = "10px";
coverBtn.onclick = startCoverCapture;
document.getElementById("scan-screen").appendChild(coverBtn);

</script>
<script>
/* ============================================================
   AUTOSUGGEST ENGINE
   - Uses libraryBooks[] built from Google Sheet
   - Grabs Google Books cover + word count when needed
============================================================ */

const manualInput = document.getElementById("manualTitleInput");
const sugDiv      = document.getElementById("suggestions");

// Show/hide the manual title search
document.getElementById("manualTitleButton").addEventListener("click", () => {
    const area = document.getElementById("manualTitleArea");
    area.style.display = area.style.display === "block" ? "none" : "block";
});


manualInput.addEventListener("input", async () => {

    const q = manualInput.value.trim().toLowerCase();
    sugDiv.innerHTML = "";

    if (!q) return;

    // Ensure data is loaded
    if (!libraryBooks.length) await loadLibraryBooks();

    // Filter all copies whose TITLE matches the input
    const matches = libraryBooks.filter(
        b => b.title.toLowerCase().includes(q)
    );

    if (!matches.length) {
        sugDiv.innerHTML = "<p>No matching books in your library.</p>";
        return;
    }

    // Group copies by LOWERCASE title
    const grouped = {};
    matches.forEach(copy => {
        const key = copy.title.toLowerCase();
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(copy);
    });

    for (let titleKey in grouped) {

        const copies = grouped[titleKey];
        const first  = copies[0]; // same title/author

        /* ---------- Google Books metadata (cached) ---------- */
        let g = googleCache[first.title];
        if (!g) {
            const gb = await lookupBook(first.title);
            const thumbnail = gb.thumbnail || "";
            const wordCount = gb.pageCount ? Math.round(gb.pageCount * 275) : null;

            g = { thumbnail, wordCount };
            googleCache[first.title] = g;
        }

        const imgHTML = g.thumbnail
            ? `<img src="${g.thumbnail}" style="width:55px;height:80px;border-radius:4px;">`
            : `<div style="width:55px;height:80px;background:#444;border-radius:4px;"></div>`;

        const wcText = g.wordCount
            ? `Estimated: ${g.wordCount.toLocaleString()} words`
            : "Word count unavailable";

        /* ---------- Build copy list ---------- */
        let copyListHTML = "";
        copies.forEach((copy, i) => {
            const onLoan = copy.onLoan;
            const grey   = onLoan ? "opacity:0.4;" : "";
            const badge  = onLoan
                ? `<span style="color:#ff9999;font-size:12px;">(On loan)</span>`
                : `<span style="color:#99ff99;font-size:12px;">(Available)</span>`;

            copyListHTML += `
                <p style="margin:2px 0; font-size:13px; ${grey}">
                    Copy ${i+1} — <b>${copy.location}</b> ${badge}
                </p>
            `;
        });

        /* ---------- Build suggestion card ---------- */
        const card = document.createElement("div");
        card.className = "book-card";
        card.style.cursor = "pointer";
        card.innerHTML = `
            ${imgHTML}
            <div style="margin-left:10px;">
                <h4 style="margin:0; font-size:16px;">${first.title}</h4>
                <p style="margin:0; font-size:14px;">${first.author}</p>
                <p style="margin:2px 0; font-size:13px; color:#ccc;">${wcText}</p>
                ${copyListHTML}
            </div>
        `;

        /* ---------- Click = open detail screen ---------- */
        card.addEventListener("click", async () => {
            const gb = await lookupBook(first.title);
            gb.title  = first.title;
            gb.author = first.author || gb.author;

            selectedBook = gb;
            showDetailScreen(gb);
        });

        sugDiv.appendChild(card);
    }
});
</script>
</body>
</html>
