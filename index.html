<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ST PHILIP'S LIBRARY BOOK LOAN/RETURN</title>

<style>
    * {
        box-sizing: border-box;
        font-family: Arial, sans-serif !important;
    }

    body {
        margin: 0;
        padding: 0;
        background: url('Background.jpg') no-repeat center center fixed;
        background-size: cover;
        color: white;
    }

    .overlay-box {
        background: rgba(0,0,0,0.55);
        padding: 20px;
        border-radius: 14px;
        width: 90%;
        max-width: 480px;
        margin: 20px auto;
        text-align: center;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    h1 {
        font-size: 26px;
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 20px;
    }

    button, select {
        width: 100%;
        padding: 14px;
        margin-top: 12px;
        border-radius: 10px;
        border: none;
        font-size: 18px;
        cursor: pointer;
        text-align: center;
        transition: transform 0.15s ease, opacity 0.2s ease;
    }

    button {
        background: #8AAA AF;
        color: black;
        font-weight: bold;
        text-transform: uppercase;
    }

    button:hover {
        transform: scale(1.03);
        opacity: 0.9;
    }

    button:active {
        transform: scale(0.95);
    }

    #reader {
        width: 100%;
        display: none;
        margin-top: 15px;
    }

    #manualTitleInput {
        padding: 12px;
        width: 100%;
        margin-top: 10px;
        border-radius: 10px;
        border: none;
        font-size: 18px;
    }

    #summary-screen {
        display: none;
    }

    #summaryCover {
        max-width: 180px;
        margin-top: 15px;
        display: none;
        border-radius: 8px;
    }

    /* Results list */
    #resultsContainer {
        margin-top: 15px;
    }

    .results-title {
        margin-top: 10px;
        font-weight: bold;
    }

    .book-card {
        background: rgba(255,255,255,0.15);
        border-radius: 12px;
        padding: 12px;
        margin-top: 10px;
        text-align: left;
        display: flex;
        gap: 10px;
        align-items: center;
        animation: fadeIn 0.3s ease;
    }

    .book-card img {
        width: 60px;
        height: 90px;
        object-fit: cover;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .book-info {
        flex: 1;
    }

    .book-info h4 {
        margin: 0 0 4px 0;
        font-size: 16px;
        font-weight: bold;
    }

    .book-info p {
        margin: 0;
        font-size: 14px;
    }

    .book-card button {
        width: auto;
        padding: 8px 12px;
        font-size: 14px;
        text-transform: uppercase;
        white-space: nowrap;
    }
</style>
</head>
<body>

<!-- MAIN SCREEN -->
<div id="scan-screen" class="overlay-box">

    <h1>ST PHILIP'S LIBRARY BOOK LOAN/RETURN</h1>

    <!-- Scan Button -->
    <button id="startScanButton">SCAN BAR CODE HERE</button>

    <!-- Manual Title Button -->
    <button id="manualTitleButton">ENTER TITLE MANUALLY</button>

    <!-- Manual Title Area -->
    <div id="manualTitleArea" style="display:none;">
        <input id="manualTitleInput" type="text" placeholder="Type book title…">
        <button id="manualSearchButton">SEARCH TITLE</button>
        <div id="resultsContainer"></div>
    </div>

    <!-- Camera View -->
    <div id="reader"></div>

    <!-- Hidden field (not heavily used now, but kept for flexibility) -->
    <input type="hidden" id="barcodeInput">

    <h3>Action</h3>
    <select id="actionSelect">
        <option value="loan">Sign Out</option>
        <option value="return">Return</option>
    </select>

    <h3>Form</h3>
    <select id="formSelect">
        <option value="">Select Form…</option>
        <option value="Form 8">Form 8</option>
        <option value="Form 7">Form 7</option>
        <option value="Form 6">Form 6</option>
        <option value="Form 5">Form 5</option>
        <option value="Form 4">Form 4</option>
        <option value="Form 3">Form 3</option>
    </select>

    <h3>Initials</h3>
    <select id="initialsSelect">
        <option value="">Select Initials…</option>
    </select>

</div>

<!-- SUMMARY SCREEN -->
<div id="summary-screen" class="overlay-box">

    <h2>Loan Summary</h2>

    <p id="summaryForm"></p>
    <p id="summaryInitials"></p>
    <p id="summaryBook"></p>
    <p id="summaryAuthor"></p>
    <p id="summaryAction"></p>
    <p id="summaryDate"></p>
    <p id="summaryLoan"></p>
    <p id="summaryReturn"></p>

    <img id="summaryCover">

    <button onclick="resetForm()">Scan Another Book</button>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ----------------------------------------------------------
   FORM → INITIALS
----------------------------------------------------------- */
const formStudents = {
    "Form 8": ["JC","ADB","CG","JG","RH","KH","AL","LLV","WN","IO","MP","HP","Ase","Ast","ST","AT","CW"],
    "Form 7": ["DAB","EC","TE","DE-S","PH-S","CH","NJ","LLFP","TM","LP","SS","AS","TS"],
    "Form 6": ["MA","EC","MH","PM","AP","MT"],
    "Form 5": ["PC","GH","CH","SH","EL","MM","RM","PS","OS","MT","AT","TW","BW"],
    "Form 4": ["AWAM","BC","HD","NN","ZJ","LN","PP","KP","NS","GSP","BT"],
    "Form 3": ["PA","PC","WH","BH"]
};

document.getElementById("formSelect").addEventListener("change", function () {
    const form = this.value;
    const initialsSelect = document.getElementById("initialsSelect");
    initialsSelect.innerHTML = `<option value="">Select Initials…</option>`;

    if (!formStudents[form]) return;

    formStudents[form].forEach(initial => {
        const opt = document.createElement("option");
        opt.value = initial;
        opt.textContent = `${initial} (${form})`;
        initialsSelect.appendChild(opt);
    });
});

/* ----------------------------------------------------------
   CAMERA SCANNER
----------------------------------------------------------- */
let qrScanner = null;

async function startScanner() {
    try {
        const cameras = await Html5Qrcode.getCameras();
        if (!cameras.length) {
            alert("No camera detected.");
            return;
        }

        const rearCam = cameras.find(cam =>
            cam.label.toLowerCase().includes("back") ||
            cam.label.toLowerCase().includes("rear")
        );
        const camId = rearCam ? rearCam.id : cameras[0].id;

        qrScanner = new Html5Qrcode("reader");
        document.getElementById("reader").style.display = "block";

        await qrScanner.start(
            camId,
            { fps: 10, qrbox: { width: 250, height: 140 } },
            scannedText => {
                // When a barcode is scanned, we use it directly as query
                handleSelectionFromQuery(scannedText);
                qrScanner.stop();
                document.getElementById("reader").style.display = "none";
            }
        );

    } catch (err) {
        console.error(err);
        alert("Unable to start camera. Check permissions.");
    }
}

document.getElementById("startScanButton").addEventListener("click", startScanner);

/* ----------------------------------------------------------
   GOOGLE BOOKS – SEARCH & LOOKUP
----------------------------------------------------------- */

// Search for top 5 matches (for manual title)
async function searchBooks(query) {
    const encoded = encodeURIComponent(query);
    const url = `https://www.googleapis.com/books/v1/volumes?q=${encoded}&maxResults=5`;

    try {
        const res = await fetch(url);
        const data = await res.json();
        if (!data.items) return [];

        return data.items.map(item => {
            const info = item.volumeInfo;
            return {
                id: item.id,
                title: info.title || "Unknown title",
                author: (info.authors && info.authors[0]) || "Unknown author",
                thumbnail: info.imageLinks ? (info.imageLinks.thumbnail || info.imageLinks.smallThumbnail || "") : ""
            };
        });
    } catch (err) {
        console.error(err);
        return [];
    }
}

// Lookup a single book (for barcode/ISBN; take the first result)
async function lookupSingleBook(query) {
    const encoded = encodeURIComponent(query);
    const url = `https://www.googleapis.com/books/v1/volumes?q=${encoded}&maxResults=1`;

    try {
        const res = await fetch(url);
        const data = await res.json();
        if (!data.items || !data.items[0]) {
            return {
                id: query,
                title: "Unknown Book",
                author: "Unknown Author",
                thumbnail: ""
            };
        }
        const item = data.items[0];
        const info = item.volumeInfo;
        return {
            id: item.id,
            title: info.title || "Unknown Book",
            author: (info.authors && info.authors[0]) || "Unknown Author",
            thumbnail: info.imageLinks ? (info.imageLinks.thumbnail || info.imageLinks.smallThumbnail || "") : ""
        };
    } catch (err) {
        console.error(err);
        return {
            id: query,
            title: "Unknown Book",
            author: "Unknown Author",
            thumbnail: ""
        };
    }
}

/* ----------------------------------------------------------
   VISUAL RESULTS LIST (CARDS)
----------------------------------------------------------- */
function renderResults(books, originalQuery) {
    const container = document.getElementById("resultsContainer");
    container.innerHTML = "";

    if (!books.length) {
        container.innerHTML = "<p>No results found.</p>";
        return;
    }

    const title = document.createElement("div");
    title.className = "results-title";
    title.textContent = "Select the correct book:";
    container.appendChild(title);

    books.forEach(book => {
        const card = document.createElement("div");
        card.className = "book-card";

        const img = document.createElement("img");
        img.src = book.thumbnail || "";
        img.alt = book.title;
        if (!book.thumbnail) {
            img.style.display = "none";
        }

        const infoDiv = document.createElement("div");
        infoDiv.className = "book-info";

        const h4 = document.createElement("h4");
        h4.textContent = book.title;

        const p = document.createElement("p");
        p.textContent = `Author: ${book.author}`;

        infoDiv.appendChild(h4);
        infoDiv.appendChild(p);

        const selBtn = document.createElement("button");
        selBtn.textContent = "SELECT";
        selBtn.addEventListener("click", () => {
            finalizeSelection(book);
        });

        card.appendChild(img);
        card.appendChild(infoDiv);
        card.appendChild(selBtn);

        container.appendChild(card);
    });
}

/* ----------------------------------------------------------
   AUTO PROCESS AFTER SELECTION / SCAN
----------------------------------------------------------- */
let loanDB = {};

function finalizeSelection(book) {
    const action = document.getElementById("actionSelect").value;
    const form = document.getElementById("formSelect").value;
    const initials = document.getElementById("initialsSelect").value;

    if (!action || !form || !initials) {
        alert("Please select Action, Form, and Initials first.");
        return;
    }

    const key = book.id || book.title;
    const today = new Date().toLocaleDateString();

    if (!loanDB[key]) loanDB[key] = {};

    if (action === "loan") loanDB[key].loan = today;
    if (action === "return") loanDB[key].return = today;

    loanDB[key].form = form;
    loanDB[key].initials = initials;

    // Show summary
    document.getElementById("scan-screen").style.display = "none";
    document.getElementById("summary-screen").style.display = "block";

    document.getElementById("summaryForm").innerHTML = `<b>Form:</b> ${form}`;
    document.getElementById("summaryInitials").innerHTML = `<b>Name:</b> ${initials}`;
    document.getElementById("summaryBook").innerHTML = `<b>Book:</b> ${book.title}`;
    document.getElementById("summaryAuthor").innerHTML = `<b>Author:</b> ${book.author}`;
    document.getElementById("summaryAction").innerHTML =
        `<b>Status:</b> ${action === "loan" ? "Signed Out" : "Returned"}`;
    document.getElementById("summaryDate").innerHTML = `<b>Date:</b> ${today}`;
    document.getElementById("summaryLoan").innerHTML =
        `<b>Date Loaned:</b> ${loanDB[key].loan || "—"}`;
    document.getElementById("summaryReturn").innerHTML =
        `<b>Date Returned:</b> ${loanDB[key].return || "—"}`;

    const img = document.getElementById("summaryCover");
    if (book.thumbnail) {
        img.src = book.thumbnail;
        img.style.display = "block";
    } else {
        img.style.display = "none";
    }
}

/* ----------------------------------------------------------
   HANDLE QUERY FROM SCANNER (NO LIST, JUST FIRST MATCH)
----------------------------------------------------------- */
async function handleSelectionFromQuery(query) {
    const book = await lookupSingleBook(query);
    finalizeSelection(book);
}

/* ----------------------------------------------------------
   MANUAL TITLE FLOW
----------------------------------------------------------- */
document.getElementById("manualTitleButton").addEventListener("click", () => {
    const area = document.getElementById("manualTitleArea");
    area.style.display = area.style.display === "none" ? "block" : "none";
    document.getElementById("resultsContainer").innerHTML = "";
});

document.getElementById("manualSearchButton").addEventListener("click", async () => {
    const typed = document.getElementById("manualTitleInput").value.trim();
    if (!typed) {
        alert("Type a title first.");
        return;
    }
    const books = await searchBooks(typed);
    renderResults(books, typed);
});

/* ----------------------------------------------------------
   RESET
----------------------------------------------------------- */
function resetForm() {
    document.getElementById("summary-screen").style.display = "none";
    document.getElementById("scan-screen").style.display = "block";

    document.getElementById("manualTitleArea").style.display = "none";
    document.getElementById("manualTitleInput").value = "";
    document.getElementById("resultsContainer").innerHTML = "";
    document.getElementById("formSelect").value = "";
    document.getElementById("initialsSelect").innerHTML =
        `<option value="">Select Initials…</option>`;
}
</script>

</body>
</html>
