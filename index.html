<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ST PHILIP'S LIBRARY BOOK LOAN/RETURN</title>

<style>
* {
    box-sizing: border-box;
    font-family: Arial, sans-serif;
}

body {
    margin: 0;
    background: url('Background.jpg') no-repeat center center fixed;
    background-size: cover;
    color: white;

    /* centre the main panel on screen */
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

/* Shared panel style */
.overlay-box {
    background: rgba(0,0,0,0.55);
    padding: 20px;
    border-radius: 14px;
    width: 90%;
    max-width: 480px;
    text-align: center;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
}

h1 {
    font-size: 24px;
    font-weight: bold;
    text-transform: uppercase;
    margin-top: 0;
}

/* Controls */
button, select {
    width: 100%;
    padding: 14px;
    margin-top: 12px;
    border-radius: 10px;
    border: none;
    font-size: 18px;
    cursor: pointer;
    text-align: center;
    transition: 0.2s;
}

button {
    background: #ffffff;
    color: #000000;
    font-weight: bold;
    text-transform: uppercase;
}

#dashboardButton {
    background: #fff4b8;
    color: #09203f;
}

button:hover { transform: scale(1.03); opacity: 0.9; }
button:active { transform: scale(0.95); }

#reader {
    width: 100%;
    margin-top: 15px;
    display: none;
    background: rgba(0,0,0,0.4);
}

/* Inputs */
#manualTitleInput,
#whoQueryInput {
    padding: 12px;
    width: 100%;
    margin-top: 10px;
    border-radius: 10px;
    border: none;
    font-size: 18px;
}

/* Results cards */
#resultsContainer {
    margin-top: 15px;
}

.book-card {
    background: rgba(255,255,255,0.15);
    border-radius: 12px;
    padding: 12px;
    margin-top: 10px;
    display: flex;
    gap: 10px;
    align-items: center;
    animation: fadeIn 0.3s ease;
}

.book-card img {
    width: 60px;
    height: 90px;
    object-fit: cover;
    border-radius: 6px;
}

.book-info h4 {
    margin: 0 0 4px 0;
    font-size: 16px;
    font-weight: bold;
}

.book-info p {
    margin: 0;
    font-size: 14px;
}

/* Detail + Summary covers */
#detailCover,
#summaryCover {
    max-width: 180px;
    margin: 10px auto;
    border-radius: 8px;
}

/* Hide other screens initially */
#detail-screen,
#summary-screen,
#who-screen {
    display: none;
}
</style>
</head>

<body>

<!-- MAIN SCREEN -->
<div id="scan-screen" class="overlay-box">
    <h1>ST PHILIP'S LIBRARY BOOK LOAN/RETURN</h1>

    <button id="startScanButton">SCAN BAR CODE HERE</button>
    <button id="manualTitleButton">ENTER TITLE MANUALLY</button>
    <button id="whoHasButton">WHO HAS THIS BOOK?</button>
    <button id="dashboardButton" onclick="window.location.href='dashboard.html'">
        GO TO DASHBOARD
    </button>

    <div id="manualTitleArea" style="display:none;">
        <input id="manualTitleInput" type="text" placeholder="Type book title…">
        <button id="manualSearchButton">SEARCH TITLE</button>
        <div id="resultsContainer"></div>
    </div>

    <div id="reader"></div>
</div>

<!-- DETAIL SCREEN (book chosen, then form/initials/action) -->
<div id="detail-screen" class="overlay-box">
    <h2 id="detailTitle"></h2>
    <p id="detailAuthor"></p>
    <img id="detailCover">

    <h3>Action</h3>
    <select id="actionSelect">
        <option value="loan">Sign Out</option>
        <option value="return">Return</option>
    </select>

    <h3>Form</h3>
    <select id="formSelect">
        <option value="">Select Form…</option>
        <option value="Form 8">Form 8</option>
        <option value="Form 7">Form 7</option>
        <option value="Form 6">Form 6</option>
        <option value="Form 5">Form 5</option>
        <option value="Form 4">Form 4</option>
        <option value="Form 3">Form 3</option>
    </select>

    <h3>Initials</h3>
    <select id="initialsSelect">
        <option value="">Select Initials…</option>
    </select>

    <button id="continueButton">CONTINUE</button>
    <button id="backToResultsButton">BACK TO RESULTS</button>
</div>

<!-- WHO HAS THIS BOOK SCREEN -->
<div id="who-screen" class="overlay-box">
    <h2>Who Has This Book?</h2>

    <input id="whoQueryInput" type="text" placeholder="Enter title or barcode…">
    <button id="whoSearchButton">SEARCH</button>

    <div id="whoResults" style="margin-top:15px; text-align:left;"></div>

    <button id="whoBackButton">BACK</button>
</div>

<!-- SUMMARY SCREEN -->
<div id="summary-screen" class="overlay-box">
    <h2>Loan Summary</h2>

    <p id="summaryForm"></p>
    <p id="summaryInitials"></p>
    <p id="summaryBook"></p>
    <p id="summaryAuthor"></p>
    <p id="summaryAction"></p>
    <p id="summaryDate"></p>
    <p id="summaryLoan"></p>
    <p id="summaryReturn"></p>

    <img id="summaryCover">

    <button onclick="resetForm()">Scan Another Book</button>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ----------------------------------------------------------
   CONFIG – GOOGLE SHEETS WEB APP
----------------------------------------------------------- */
const SHEET_URL = "https://script.google.com/macros/s/AKfycbx8qir32wSh0gAkGLIHDxpBSrl0xdBlRceytBVUe2MAm5iDWlNKnYdseJolhwlLE8pqAg/exec";

/* ----------------------------------------------------------
   FORM → INITIALS
----------------------------------------------------------- */
const formStudents = {
    "Form 8": ["JC","ADB","CG","JG","RH","KH","AL","LLV","WN","IO","MP","HP","Ase","Ast","ST","AT","CW"],
    "Form 7": ["DAB","EC","TE","DE-S","PH-S","CH","NJ","LLFP","TM","LP","SS","AS","TS"],
    "Form 6": ["MA","EC","MH","PM","AP","MT"],
    "Form 5": ["PC","GH","CH","SH","EL","MM","RM","PS","OS","MT","AT","TW","BW"],
    "Form 4": ["AWAM","BC","HD","NN","ZJ","LN","PP","KP","NS","GSP","BT"],
    "Form 3": ["PA","PC","WH","BH"]
};

document.getElementById("formSelect").addEventListener("change", function () {
    const form = this.value;
    const initialsSelect = document.getElementById("initialsSelect");
    initialsSelect.innerHTML = `<option value="">Select Initials…</option>`;

    if (!formStudents[form]) return;

    formStudents[form].forEach(initial => {
        const opt = document.createElement("option");
        opt.value = initial;
        opt.textContent = `${initial} (${form})`;
        initialsSelect.appendChild(opt);
    });
});

/* ----------------------------------------------------------
   CAMERA SCANNING → LOOK UP 1 BOOK
----------------------------------------------------------- */
let qrScanner = null;
let selectedBook = null; // currently chosen book object

async function startScanner() {
    try {
        const cameras = await Html5Qrcode.getCameras();
        if (!cameras.length) {
            alert("No camera detected.");
            return;
        }

        const rear = cameras.find(c =>
            c.label.toLowerCase().includes("back") ||
            c.label.toLowerCase().includes("rear")
        );
        const camId = rear ? rear.id : cameras[0].id;

        qrScanner = new Html5Qrcode("reader");
        document.getElementById("reader").style.display = "block";

        await qrScanner.start(
            camId,
            { fps: 10, qrbox: { width: 250, height: 140 } },
            async text => {
                const book = await lookupSingle(text);
                showDetailScreen(book);
                qrScanner.stop();
                document.getElementById("reader").style.display = "none";
            }
        );
    } catch (err) {
        console.error(err);
        alert("Camera cannot start. Please allow camera permissions.");
    }
}

document.getElementById("startScanButton").addEventListener("click", startScanner);

/* ----------------------------------------------------------
   GOOGLE BOOKS HELPERS
----------------------------------------------------------- */

// Top 5 matches for manual title search
async function searchBooks(query) {
    const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=5`;
    try {
        const res = await fetch(url);
        const data = await res.json();
        if (!data.items) return [];

        return data.items.map(item => {
            const info = item.volumeInfo;
            return {
                id: item.id,
                title: info.title || "Unknown title",
                author: info.authors?.[0] || "Unknown author",
                thumbnail: info.imageLinks?.thumbnail || ""
            };
        });
    } catch (err) {
        console.error(err);
        return [];
    }
}

// Single best match (used for scanner)
async function lookupSingle(query) {
    const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=1`;
    try {
        const res = await fetch(url);
        const data = await res.json();
        if (!data.items) {
            return { id: query, title: "Unknown", author: "Unknown", thumbnail: "" };
        }
        const item = data.items[0];
        const info = item.volumeInfo;
        return {
            id: item.id,
            title: info.title || "Unknown",
            author: info.authors?.[0] || "Unknown",
            thumbnail: info.imageLinks?.thumbnail || ""
        };
    } catch (err) {
        console.error(err);
        return { id: query, title: "Unknown", author: "Unknown", thumbnail: "" };
    }
}

/* ----------------------------------------------------------
   RENDER TITLE SEARCH RESULTS AS CARDS
----------------------------------------------------------- */
function renderResults(list) {
    const container = document.getElementById("resultsContainer");
    container.innerHTML = "";

    if (!list.length) {
        container.innerHTML = "<p>No results found.</p>";
        return;
    }

    const title = document.createElement("h3");
    title.textContent = "Select the correct book:";
    title.style.marginTop = "10px";
    container.appendChild(title);

    list.forEach(book => {
        const card = document.createElement("div");
        card.className = "book-card";

        const img = document.createElement("img");
        img.src = book.thumbnail || "";
        if (!book.thumbnail) img.style.display = "none";

        const info = document.createElement("div");
        info.className = "book-info";

        const h4 = document.createElement("h4");
        h4.textContent = book.title;

        const p = document.createElement("p");
        p.textContent = "by " + book.author;

        info.appendChild(h4);
        info.appendChild(p);

        card.appendChild(img);
        card.appendChild(info);

        card.addEventListener("click", () => showDetailScreen(book));

        container.appendChild(card);
    });
}

/* ----------------------------------------------------------
   MANUAL TITLE SEARCH FLOW
----------------------------------------------------------- */
document.getElementById("manualTitleButton").addEventListener("click", () => {
    const area = document.getElementById("manualTitleArea");
    area.style.display = area.style.display === "none" ? "block" : "none";
    document.getElementById("resultsContainer").innerHTML = "";
});

document.getElementById("manualSearchButton").addEventListener("click", async () => {
    const typed = document.getElementById("manualTitleInput").value.trim();
    if (!typed) {
        alert("Type a title first.");
        return;
    }
    const list = await searchBooks(typed);
    renderResults(list);
});

/* ----------------------------------------------------------
   SHOW DETAIL SCREEN
----------------------------------------------------------- */
function showDetailScreen(book) {
    selectedBook = book;

    // Hide main, show detail
    document.getElementById("scan-screen").style.display = "none";
    document.getElementById("detail-screen").style.display = "block";

    // Reset dropdowns
    document.getElementById("formSelect").value = "";
    document.getElementById("initialsSelect").innerHTML = `<option value="">Select Initials…</option>`;
    document.getElementById("actionSelect").value = "loan";

    // Fill book details
    document.getElementById("detailTitle").textContent = book.title;
    document.getElementById("detailAuthor").textContent = "Author: " + book.author;

    const img = document.getElementById("detailCover");
    if (book.thumbnail) {
        img.src = book.thumbnail;
        img.style.display = "block";
    } else {
        img.style.display = "none";
    }
}

// Back to main from detail
document.getElementById("backToResultsButton").addEventListener("click", () => {
    document.getElementById("detail-screen").style.display = "none";
    document.getElementById("scan-screen").style.display = "block";
});

/* ----------------------------------------------------------
   GOOGLE SHEETS INTEGRATION
   Each CONTINUE logs a row: BookID, Title, Author, Form, Initials,
   LoanDate, ReturnDate, Status (Loan/Return)
----------------------------------------------------------- */
async function logToSheet(record) {
    try {
        await fetch(SHEET_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(record)
        });
    } catch (err) {
        console.error("Error logging to sheet", err);
    }
}

// Get all sheet data as 2D array
async function fetchSheetData() {
    try {
        const res = await fetch(SHEET_URL);
        const data = await res.json(); // [[headers], [row1], …]
        return data;
    } catch (err) {
        console.error("Error fetching sheet data", err);
        return [];
    }
}

// For returns: find most recent loan date in the sheet
async function getLastLoanDate(bookKey, title) {
    const data = await fetchSheetData();
    if (!data || data.length < 2) return "";

    const rows = data.slice(1); // skip header
    // Rows assumed oldest → newest
    for (let i = rows.length - 1; i >= 0; i--) {
        const row = rows[i];
        const [sheetBookID, sheetTitle, , loanDate, status] = row;
        if (
            status === "Loan" &&
            (sheetBookID === bookKey || (sheetTitle && sheetTitle === title))
        ) {
            return loanDate || "";
        }
    }
    return "";
}

/* ----------------------------------------------------------
   FINALISE LOAN / RETURN (CONTINUE BUTTON)
----------------------------------------------------------- */
document.getElementById("continueButton").addEventListener("click", async () => {
    if (!selectedBook) {
        alert("No book selected.");
        return;
    }

    const action   = document.getElementById("actionSelect").value; // loan/return
    const form     = document.getElementById("formSelect").value;
    const initials = document.getElementById("initialsSelect").value;

    if (!form || !initials) {
        alert("Please select Form and Initials.");
        return;
    }

    const key   = selectedBook.id || selectedBook.title;
    const today = new Date().toLocaleDateString();

    let loanDateForSummary   = "";
    let returnDateForSummary = "";

    if (action === "loan") {
        loanDateForSummary   = today;
        returnDateForSummary = "—";
    } else {
        // For return, look up last loan date in sheet
        loanDateForSummary   = await getLastLoanDate(key, selectedBook.title) || "—";
        returnDateForSummary = today;
    }

    // Log to sheet (event log)
    const record = {
        BookID: key,
        Title: selectedBook.title,
        Author: selectedBook.author,
        Form: form,
        Initials: initials,
        LoanDate: action === "loan" ? today : (loanDateForSummary === "—" ? "" : loanDateForSummary),
        ReturnDate: action === "return" ? today : "",
        Status: action === "loan" ? "Loan" : "Return"
    };

    logToSheet(record); // fire-and-forget

    // Fill summary screen
    document.getElementById("summaryForm").innerHTML     = `<b>Form:</b> ${form}`;
    document.getElementById("summaryInitials").innerHTML = `<b>Name:</b> ${initials}`;
    document.getElementById("summaryBook").innerHTML     = `<b>Book:</b> ${selectedBook.title}`;
    document.getElementById("summaryAuthor").innerHTML   = `<b>Author:</b> ${selectedBook.author}`;
    document.getElementById("summaryAction").innerHTML   =
        `<b>Status:</b> ${action === "loan" ? "Signed Out" : "Returned"}`;
    document.getElementById("summaryDate").innerHTML     = `<b>Today:</b> ${today}`;
    document.getElementById("summaryLoan").innerHTML     = `<b>Date Loaned:</b> ${loanDateForSummary}`;
    document.getElementById("summaryReturn").innerHTML   = `<b>Date Returned:</b> ${returnDateForSummary}`;

    const sImg = document.getElementById("summaryCover");
    if (selectedBook.thumbnail) {
        sImg.src = selectedBook.thumbnail;
        sImg.style.display = "block";
    } else {
        sImg.style.display = "none";
    }

    // Switch screens
    document.getElementById("detail-screen").style.display  = "none";
    document.getElementById("summary-screen").style.display = "block";
});

/* ----------------------------------------------------------
   WHO HAS THIS BOOK? (LIVE FROM GOOGLE SHEETS)
----------------------------------------------------------- */

// Open who-screen
document.getElementById("whoHasButton").addEventListener("click", () => {
    document.getElementById("scan-screen").style.display = "none";
    document.getElementById("who-screen").style.display  = "block";
    document.getElementById("whoQueryInput").value = "";
    document.getElementById("whoResults").innerHTML = "";
});

// Back from who-screen
document.getElementById("whoBackButton").addEventListener("click", () => {
    document.getElementById("who-screen").style.display  = "none";
    document.getElementById("scan-screen").style.display = "block";
});

document.getElementById("whoSearchButton").addEventListener("click", async () => {
    const query = document.getElementById("whoQueryInput").value.trim().toLowerCase();
    const out   = document.getElementById("whoResults");

    if (!query) {
        out.innerHTML = "<p>Please enter a title or barcode.</p>";
        return;
    }

    const data = await fetchSheetData();
    if (!data || data.length < 2) {
        out.innerHTML = "<p>No data in database yet.</p>";
        return;
    }

    const rows = data.slice(1); // skip header

    // Build map of latest state per BookID|Title
    const latest = {};
    rows.forEach(row => {
        const [bookID, title, author, form, initials, loanDate, returnDate, status] = row;
        const key = (bookID || "") + "|" + (title || "");
        latest[key] = { bookID, title, author, form, initials, loanDate, returnDate, status };
    });

    // Filter by query
    const matches = Object.values(latest).filter(r => {
        const t  = (r.title || "").toLowerCase();
        const id = (r.bookID || "").toLowerCase();
        return t.includes(query) || id.includes(query);
    });

    if (!matches.length) {
        out.innerHTML = "<p>No records found for this book.</p>";
        return;
    }

    out.innerHTML = "";

    matches.forEach(rec => {
        let html = `<div style="margin-bottom:12px; background:rgba(255,255,255,0.12); padding:10px; border-radius:10px;">`;
        html += `<p><b>Title:</b> ${rec.title || "Unknown"}</p>`;
        html += `<p><b>Author:</b> ${rec.author || "Unknown"}</p>`;
        html += `<p><b>Form:</b> ${rec.form || "—"}</p>`;
        html += `<p><b>Initials:</b> ${rec.initials || "—"}</p>`;
        html += `<p><b>Date Loaned:</b> ${rec.loanDate || "—"}</p>`;
        html += `<p><b>Date Returned:</b> ${rec.returnDate || "—"}</p>`;

        if (rec.status === "Loan" && !rec.returnDate) {
            html += `<p style="color:#ffcc66;"><b>Status:</b> Currently loaned out</p>`;
        } else if (rec.status === "Return" || rec.returnDate) {
            html += `<p style="color:#99ff99;"><b>Status:</b> Returned</p>`;
        } else {
            html += `<p>Status unknown</p>`;
        }

        html += `</div>`;
        out.innerHTML += html;
    });
});

/* ----------------------------------------------------------
   RESET EVERYTHING (after summary)
----------------------------------------------------------- */
function resetForm() {
    selectedBook = null;

    document.getElementById("summary-screen").style.display = "none";
    document.getElementById("detail-screen").style.display  = "none";
    document.getElementById("who-screen").style.display     = "none";
    document.getElementById("scan-screen").style.display    = "block";

    document.getElementById("manualTitleInput").value = "";
    document.getElementById("manualTitleArea").style.display = "none";
    document.getElementById("resultsContainer").innerHTML = "";
    document.getElementById("reader").style.display = "none";

    if (qrScanner) {
        try { qrScanner.stop(); } catch(e) {}
    }
}
</script>

</body>
</html>
