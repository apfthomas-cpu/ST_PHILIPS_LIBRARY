<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ST PHILIP'S LIBRARY BOOK LOAN/RETURN</title>

<style>
* { box-sizing:border-box; font-family:Arial, sans-serif; }
body {
    margin:0;
    background:#00172b url('Background.jpg') no-repeat center center fixed;
    background-size:cover;
    color:white;
}
.page {
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    padding:16px;
}
.overlay-box {
    background:rgba(0,0,0,0.6);
    padding:20px;
    border-radius:14px;
    max-width:520px;
    width:100%;
    text-align:center;
    animation:fadeIn 0.4s ease;
}
@keyframes fadeIn {
    from { opacity:0; transform:translateY(10px); }
    to   { opacity:1; transform:translateY(0); }
}
h1 { font-size:22px; margin-top:0; }

button, select {
    width:100%;
    padding:14px;
    margin-top:12px;
    border-radius:10px;
    border:none;
    font-size:16px;
    font-weight:bold;
    cursor:pointer;
    text-transform:uppercase;
    transition:0.2s;
}
button { background:#fff; color:#000; }
button:hover { transform:scale(1.03); opacity:0.95; }
button:active { transform:scale(0.97); }

input {
    width:100%;
    padding:10px;
    border-radius:10px;
    border:none;
    margin-top:10px;
    font-size:16px;
}

.book-card {
    background:rgba(255,255,255,0.1);
    border-radius:12px;
    padding:10px;
    margin-top:8px;
    display:flex;
    gap:10px;
    align-items:flex-start;
    cursor:pointer;
}
.book-card img {
    width:55px;
    height:80px;
    object-fit:cover;
    border-radius:6px;
}

#detailCover,#summaryCover {
    max-width:180px;
    margin:10px auto;
    border-radius:8px;
}

#detail-screen,#form-screen,#summary-screen,#who-screen {
    display:none;
}

#copiesInfo { margin-top:10px; text-align:left; font-size:14px; }
#suggestions { margin-top:10px; }
#reader { margin-top:10px; }

.small { font-size:12px; opacity:0.8; }
</style>

<!-- OCR for cover text -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>

<body>
<div class="page">

<!-- =======================
     START SCREEN
======================= -->
<div id="scan-screen" class="overlay-box">
    <h1>ST PHILIP'S LIBRARY BOOK LOAN/RETURN</h1>

    <button id="coverButton">CAPTURE BOOK COVER</button>
    <button id="manualTitleButton">SEARCH TITLE MANUALLY</button>
    <button id="whoHasButton">WHO HAS THIS BOOK?</button>

    <div id="manualTitleArea" style="display:none; margin-top:10px;">
        <input id="manualTitleInput" type="text" placeholder="Start typing a book title…">
        <div id="suggestions"></div>
    </div>

    <div id="reader"></div>

    <p class="small" style="margin-top:8px;">
        Only books in our library catalogue will appear.
    </p>
</div>

<!-- =======================
     DETAIL SCREEN
======================= -->
<div id="detail-screen" class="overlay-box">
    <h2 id="detailTitle"></h2>
    <p id="detailAuthor"></p>
    <img id="detailCover" style="display:none;">
    <p id="detailWordCount"></p>

    <div id="copiesInfo"></div>

    <button id="signOutButton">SIGN THIS BOOK OUT</button>
    <button id="returnButton">RETURN THIS BOOK</button>
    <button id="detailWhoHasButton">WHO HAS THIS BOOK?</button>
    <button id="backToStartButton">BACK</button>
</div>

<!-- =======================
     FORM SCREEN
======================= -->
<div id="form-screen" class="overlay-box">
    <h2>Complete Your Details</h2>

    <h3>Form</h3>
    <select id="formSelect">
        <option value="">Select Form…</option>
        <option value="Form 3">Form 3</option>
        <option value="Form 4">Form 4</option>
        <option value="Form 5">Form 5</option>
        <option value="Form 6">Form 6</option>
        <option value="Form 7">Form 7</option>
        <option value="Form 8">Form 8</option>
    </select>

    <h3>Initials</h3>
    <select id="initialsSelect">
        <option value="">Select Initials…</option>
    </select>

    <h3 id="shelfLabel">Shelf</h3>
    <select id="shelfSelect">
        <option value="">Select Shelf…</option>
        <option value="Big School Room">Big School Room</option>
        <option value="Form 3">Form 3</option>
        <option value="Form 4">Form 4</option>
        <option value="Form 5">Form 5</option>
        <option value="Form 6">Form 6</option>
        <option value="Form 7">Form 7</option>
        <option value="Form 8">Form 8</option>
    </select>

    <button id="formContinueBtn">CONTINUE</button>
    <button id="formBackBtn">BACK</button>
</div>

<!-- =======================
     WHO HAS THIS BOOK
======================= -->
<div id="who-screen" class="overlay-box">
    <h2>Who Has This Book?</h2>

    <input id="whoQueryInput" type="text" placeholder="Enter part of the title…">
    <button id="whoSearchButton">SEARCH</button>

    <div id="whoResults" style="margin-top:15px; text-align:left; font-size:14px;"></div>

    <button id="whoBackButton">BACK</button>
</div>

<!-- =======================
     SUMMARY SCREEN
======================= -->
<div id="summary-screen" class="overlay-box">
    <h2>Summary</h2>

    <p id="summaryForm"></p>
    <p id="summaryInitials"></p>
    <p id="summaryShelf"></p>
    <p id="summaryBook"></p>
    <p id="summaryAuthor"></p>
    <p id="summaryAction"></p>
    <p id="summaryDate"></p>

    <img id="summaryCover" style="display:none;">

    <button id="arButton" style="margin-top:10px; display:none;">
        LOG YOUR WORD COUNT ON ACCELERATED READER
    </button>

    <button id="summaryBackBtn" style="margin-top:10px;">Scan Another Book</button>
</div>

<script>
/* ===========================================================
   CONFIG + GLOBAL STATE
=========================================================== */

const SHEET_URL = "https://script.google.com/macros/s/AKfycbx33DPCRwrYsNdsB6xfUWn63d9MF8RKDA-Cw8qIkXfKFS_ndDYX9ULxRowE3aRumWyT/exec";

const AR_URL =
  "https://global-zone08.renaissance-go.com/identityservice/sso/tenant?returnUrl=%2Fidentityservice%2Fsso%2Fconnect%2Fauthorize%2Fcallback%3Fclient_id%3Dstudentportallinux%26redirect_uri%3Dhttps%253A%252F%252Fglobal-zone08.renaissance-go.com%252Fstudentportal%252Fsignin-oidc%26response_type%3Did_token%26scope%3Dopenid%2520ren.profile%26response_mode%3Dform_post%26nonce%3D639008158509953001.Y2Q0NWIxYmQtNGI1MC00ZWRmLWIwN2YtZDAzNzJmYWZmMTcxOTY2NGExYmQtMDAwMy00NGFjLWIzZTQtN2MyYzI0M2Y1N2Yy%26prompt%3Dlogin%26state%3DCfDJ8DPUwk2T_CRBtvGzYEDp-ve75Wt-t6h_dPHlpD6RnyS_miIEHX4NCYeQWQW-BFY1nDasGpzBbaZMwG0tmr_2TNqvcfRpAwE7ygBjeP9fB23tHENoHcn-vLmEBHD0KWtQnFmpvUmAB3jsNNylvjBRcqdtISMOn4lp5mcQP8A2-S-ShyEmdT57JktdEHm1TfI0w5qdh5dqMqEWzfKXfVA08AZsSSBPCwpYL-8JC0ED0Q0nPjZsaeJxasMV54P2Py_tMdPPr9wJ_mB9jBfaHDit0Wg4ZlIJv-_pNWBVztTAGXMPjfApo4XGX8QW4ZeJt8Q9zHTJriFVJt9wjmrPpF3N2OqO6td351RCZEd0lMPzLlq94Ma_Ppi3C5ZCUYqA-KAuOspYRLwIBMOVYbgto2VyvloWMUNofRgpBXafKGuAe3LepQq98jK31EMiFQ4JJIrR7Q%26x-client-SKU%3DID_NETSTANDARD2_0%26x-client-ver%3D6.8.0.0%26suppressed_prompt%3Dlogin";

const formStudents = {
  "Form 8": ["JC","ADB","CG","JG","RH","KH","AL","LLV","WN","IO","MP","HP","Ase","Ast","ST","AT","CW"],
  "Form 7": ["DAB","EC","TE","DE-S","PH-S","CH","NJ","LLFP","TM","LP","SS","AS","TS"],
  "Form 6": ["MA","EC","MH","PM","AP","MT"],
  "Form 5": ["PC","GH","CH","SH","EL","MM","RM","PS","OS","MT","AT","TW","BW"],
  "Form 4": ["AWAM","BC","HD","NN","ZJ","LN","PP","KP","NS","GSP","BT"],
  "Form 3": ["PA","PC","WH","BH"]
};

let books = [];        // from "Books"
let loans = [];        // from "Loans list"
let googleCache = {};  // title -> {thumbnail, pageCount, wordCount}
let selectedBook = null;
let pendingAction = null;   // "Loan" or "Return"
let videoStream = null;

/* ===========================================================
   LOAD DATA FROM GOOGLE SHEETS
=========================================================== */

async function loadLibraryData() {
  try {
    const res = await fetch(SHEET_URL);
    const json = await res.json();
    books = json.books || [];
    loans = json.loans || [];
  } catch (err) {
    console.error("Error loading data:", err);
  }
}
loadLibraryData();

/* ===========================================================
   STATS + OPEN LOANS HELPERS
=========================================================== */

function getStatsForTitle(title) {
  const t = (title || "").toLowerCase();

  const copies = books.filter(b => (b.Title || "").toLowerCase() === t);
  const totalCopies = copies.length;

  let netLoans = 0;
  loans.forEach(r => {
    if ((r.Title || "").toLowerCase() !== t) return;
    const status = (r.Status || "").toLowerCase();
    if (status === "loan")   netLoans++;
    if (status === "return") netLoans--;
  });

  const onLoan = Math.max(netLoans, 0);
  const available = Math.max(totalCopies - onLoan, 0);

  return { totalCopies, onLoan, available };
}

function getOpenLoansForTitle(title) {
  const t = (title || "").toLowerCase();
  const map = {}; // key = form|initials -> netLoans

  loans.forEach(r => {
    if ((r.Title || "").toLowerCase() !== t) return;
    const form = (r.Form || "").trim();
    const initials = (r.Initials || "").trim();
    if (!form || !initials) return;

    const key = form + "|" + initials;
    if (!map[key]) map[key] = 0;

    const status = (r.Status || "").toLowerCase();
    if (status === "loan")   map[key]++;
    if (status === "return") map[key]--;
  });

  const list = [];
  Object.keys(map).forEach(k => {
    if (map[k] > 0) {
      const [form, initials] = k.split("|");
      list.push({ form, initials, copies: map[k] });
    }
  });
  return list;
}

/* ===========================================================
   CAMERA HELPERS
=========================================================== */

function stopCamera() {
  const reader = document.getElementById("reader");
  reader.style.display = "none";
  reader.innerHTML = "";
  if (videoStream) {
    videoStream.getTracks().forEach(t => t.stop());
    videoStream = null;
  }
}

/* ===========================================================
   COVER CAPTURE (OCR)
=========================================================== */

async function startCoverCapture() {
  stopCamera();
  const reader = document.getElementById("reader");
  reader.style.display = "block";
  reader.innerHTML = `
    <div style="position:relative;width:100%;border-radius:10px;overflow:hidden;">
      <video id="coverVideo" autoplay playsinline style="width:100%;"></video>
    </div>
    <div style="display:flex;gap:10px;margin-top:10px;">
      <button id="captureBtn" style="flex:1;">CAPTURE</button>
      <button id="cancelCaptureBtn" style="flex:1;">CANCEL</button>
    </div>
    <p class="small" style="margin-top:8px;">Line the book cover up, then press CAPTURE.</p>
  `;

  const constraintsList = [
    { video: { facingMode: { exact: "environment" } } },
    { video: { facingMode: "environment" } },
    { video: true }
  ];

  let stream = null;
  for (const c of constraintsList) {
    try {
      stream = await navigator.mediaDevices.getUserMedia(c);
      break;
    } catch (err) {
      console.warn("Constraint failed, trying next:", err);
    }
  }

  if (!stream) {
    alert("Unable to access camera.");
    reader.style.display = "none";
    return;
  }

  videoStream = stream;
  const video = document.getElementById("coverVideo");
  video.srcObject = stream;

  document.getElementById("cancelCaptureBtn").onclick = () => {
    stopCamera();
  };

  document.getElementById("captureBtn").onclick = async () => {
    const canvas = document.createElement("canvas");
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    const scale = 0.6;
    canvas.width  = vw * scale;
    canvas.height = vh * scale;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataURL = canvas.toDataURL("image/jpeg", 0.9);

    stopCamera();
    await processCoverImage(dataURL);
  };
}

async function processCoverImage(dataURL) {
  const reader = document.getElementById("reader");
  reader.style.display = "block";
  reader.innerHTML = `
    <p>Reading cover…</p>
    <p class="small" id="ocrStatus">Initialising…</p>
  `;
  const statusEl = document.getElementById("ocrStatus");

  try {
    const result = await Tesseract.recognize(dataURL, "eng", {
      logger: m => { statusEl.textContent = m.status || "Processing…"; }
    });

    const text = result.data.text || "";
    const lines = text
      .split("\n")
      .map(l => l.trim())
      .filter(l => l.length > 3 && /[A-Za-z]/.test(l));

    if (!lines.length) {
      reader.innerHTML = `
        <p>No clear text detected on the cover.</p>
        <button onclick="startCoverCapture()">TRY AGAIN</button>
      `;
      return;
    }

    lines.sort((a,b) => Math.abs(a.length - 25) - Math.abs(b.length - 25));
    const guess = lines[0];

    reader.style.display = "none";
    document.getElementById("manualTitleArea").style.display = "block";
    const input = document.getElementById("manualTitleInput");
    input.value = guess;
    input.dispatchEvent(new Event("input"));
  } catch (err) {
    console.error("OCR error:", err);
    reader.innerHTML = `
      <p>Something went wrong reading the cover.</p>
      <button onclick="startCoverCapture()">TRY AGAIN</button>
    `;
  }
}

/* ===========================================================
   GOOGLE BOOKS LOOKUP (cover + word count)
=========================================================== */

async function lookupGoogleBook(title) {
  if (googleCache[title]) return googleCache[title];

  const url =
    "https://www.googleapis.com/books/v1/volumes?q=" +
    encodeURIComponent(title) + "&maxResults=1";

  try {
    const res = await fetch(url);
    const data = await res.json();
    if (!data.items) {
      googleCache[title] = { thumbnail:"", pageCount:null, wordCount:null };
      return googleCache[title];
    }
    const info = data.items[0].volumeInfo;
    const pageCount = info.pageCount || null;
    const wordCount = pageCount ? Math.round(pageCount * 275) : null;
    const thumbnail = (info.imageLinks && info.imageLinks.thumbnail) || "";
    googleCache[title] = { thumbnail, pageCount, wordCount };
    return googleCache[title];
  } catch (err) {
    console.error("Google Books error:", err);
    googleCache[title] = { thumbnail:"", pageCount:null, wordCount:null };
    return googleCache[title];
  }
}

/* ===========================================================
   OPEN DETAIL SCREEN FOR A TITLE
=========================================================== */

async function openBookByTitle(title, author) {
  stopCamera();
  await loadLibraryData();

  selectedBook = { title, author, thumbnail:"", pageCount:null };
  const g = await lookupGoogleBook(title);
  selectedBook.thumbnail = g.thumbnail;
  selectedBook.pageCount = g.pageCount;

  document.getElementById("scan-screen").style.display    = "none";
  document.getElementById("who-screen").style.display     = "none";
  document.getElementById("summary-screen").style.display = "none";
  document.getElementById("form-screen").style.display    = "none";
  document.getElementById("detail-screen").style.display  = "block";

  document.getElementById("detailTitle").textContent  = title;
  document.getElementById("detailAuthor").textContent = "Author: " + (author || "Unknown");

  const cover = document.getElementById("detailCover");
  if (g.thumbnail) {
    cover.src = g.thumbnail;
    cover.style.display = "block";
  } else {
    cover.style.display = "none";
  }

  const wcEl = document.getElementById("detailWordCount");
  if (g.wordCount) {
    wcEl.textContent = `Estimated word count: ~${g.wordCount.toLocaleString()} words`;
  } else {
    wcEl.textContent = "Estimated word count unavailable.";
  }

  const stats = getStatsForTitle(title);
  const infoDiv = document.getElementById("copiesInfo");
  if (!stats.totalCopies) {
    infoDiv.innerHTML = "<b>This title is not in our catalogue.</b>";
  } else {
    infoDiv.innerHTML =
      `<b>Total copies:</b> ${stats.totalCopies}<br>` +
      `<b>On loan:</b> ${stats.onLoan}<br>` +
      `<b>Available now:</b> ${stats.available}`;
  }

  const openLoans = getOpenLoansForTitle(title);
  document.getElementById("returnButton").style.display =
    openLoans.length ? "block" : "none";
}

/* ===========================================================
   MANUAL SEARCH AUTOSUGGEST
=========================================================== */

const manualInput = document.getElementById("manualTitleInput");
const sugDiv      = document.getElementById("suggestions");

document.getElementById("manualTitleButton").addEventListener("click", () => {
  const area = document.getElementById("manualTitleArea");
  area.style.display = area.style.display === "block" ? "none" : "block";
});

manualInput.addEventListener("input", async () => {
  const q = manualInput.value.trim().toLowerCase();
  sugDiv.innerHTML = "";
  if (!q) return;

  await loadLibraryData();

  const matches = books.filter(b =>
    (b.Title || "").toLowerCase().includes(q)
  );
  if (!matches.length) {
    sugDiv.innerHTML = "<p>No matching books in our library.</p>";
    return;
  }

  const byTitle = {};
  matches.forEach(b => {
    const key = (b.Title || "").toLowerCase();
    if (!byTitle[key]) byTitle[key] = { title:b.Title, author:b.Author };
  });

  for (let key in byTitle) {
    const entry = byTitle[key];
    const stats = getStatsForTitle(entry.title);
    const g = await lookupGoogleBook(entry.title);

    const card = document.createElement("div");
    card.className = "book-card";

    const imgHTML = g.thumbnail
      ? `<img src="${g.thumbnail}">`
      : `<div style="width:55px;height:80px;border-radius:6px;background:#333;"></div>`;

    const wcText = g.wordCount
      ? `Estimated: ${g.wordCount.toLocaleString()} words`
      : `Word count unavailable`;

    card.innerHTML = `
      ${imgHTML}
      <div style="flex:1;">
        <h4 style="margin:0 0 4px 0;">${entry.title}</h4>
        <p style="margin:0; font-size:14px;">${entry.author || "Unknown author"}</p>
        <p style="margin:2px 0; font-size:13px; color:#ccc;">${wcText}</p>
        <p style="margin:2px 0; font-size:13px;">
          Copies: <b>${stats.totalCopies}</b>,
          On loan: <b>${stats.onLoan}</b>,
          Available: <b>${stats.available}</b>
        </p>
      </div>
    `;

    card.addEventListener("click", () => {
      openBookByTitle(entry.title, entry.author);
    });

    sugDiv.appendChild(card);
  }
});

/* ===========================================================
   FORM / INITIALS / LOAN / RETURN
=========================================================== */

document.getElementById("formSelect").addEventListener("change", () => {
  const form = document.getElementById("formSelect").value;
  const sel  = document.getElementById("initialsSelect");
  sel.innerHTML = `<option value="">Select Initials…</option>`;
  if (formStudents[form]) {
    formStudents[form].forEach(initial => {
      const op = document.createElement("option");
      op.value = initial;
      op.textContent = initial;
      sel.appendChild(op);
    });
  }
});

document.getElementById("signOutButton").addEventListener("click", () => {
  pendingAction = "Loan";
  openFormScreen();
});

document.getElementById("returnButton").addEventListener("click", () => {
  pendingAction = "Return";
  openFormScreen();
});

function openFormScreen() {
  if (!selectedBook) return;

  document.getElementById("formSelect").value = "";
  document.getElementById("initialsSelect").innerHTML =
    `<option value="">Select Initials…</option>`;
  document.getElementById("shelfSelect").value = "";

  document.getElementById("shelfLabel").textContent =
    pendingAction === "Loan"
      ? "Which shelf are you taking the book from?"
      : "Which shelf are you returning the book to?";

  document.getElementById("detail-screen").style.display  = "none";
  document.getElementById("form-screen").style.display    = "block";
}

document.getElementById("formBackBtn").addEventListener("click", () => {
  document.getElementById("form-screen").style.display   = "none";
  document.getElementById("detail-screen").style.display = "block";
});

document.getElementById("formContinueBtn").addEventListener("click", async () => {
  if (!selectedBook || !pendingAction) {
    alert("No book or action selected.");
    return;
  }

  const form  = document.getElementById("formSelect").value;
  const ini   = document.getElementById("initialsSelect").value;
  const shelf = document.getElementById("shelfSelect").value;

  if (!form || !ini) {
    alert("Please select Form and Initials.");
    return;
  }
  if (!shelf) {
    alert("Please select a shelf.");
    return;
  }

  await loadLibraryData();

  const today = new Date().toLocaleDateString();

  if (pendingAction === "Return") {
    const openLoans = getOpenLoansForTitle(selectedBook.title)
      .filter(x => x.form === form && x.initials === ini);
    if (!openLoans.length) {
      alert("Our records show no outstanding copy of this book for your name.");
      return;
    }
  }

  const record = {
    Title: selectedBook.title,
    Author: selectedBook.author,
    Form: form,
    Initials: ini,
    LoanDate: pendingAction === "Loan"   ? today : "",
    ReturnDate: pendingAction === "Return" ? today : "",
    OriginalLocation: pendingAction === "Loan"   ? shelf : "",
    NewLocation: pendingAction === "Return" ? shelf : "",
    Status: pendingAction
  };

  try {
    await fetch(SHEET_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(record)
    });
  } catch (err) {
    console.error("POST error:", err);
    alert("Could not send data to the sheet.");
    return;
  }

  await loadLibraryData();
  showSummary(record);
});

function showSummary(record) {
  document.getElementById("form-screen").style.display   = "none";
  document.getElementById("detail-screen").style.display = "none";
  document.getElementById("summary-screen").style.display = "block";

  document.getElementById("summaryForm").innerHTML      = `<b>Form:</b> ${record.Form}`;
  document.getElementById("summaryInitials").innerHTML  = `<b>Name:</b> ${record.Initials}`;
  document.getElementById("summaryShelf").innerHTML     =
    `<b>${record.Status === "Loan" ? "Taken from" : "Returned to"} shelf:</b> ` +
    (record.Status === "Loan" ? record.OriginalLocation : record.NewLocation);
  document.getElementById("summaryBook").innerHTML      = `<b>Book:</b> ${record.Title}`;
  document.getElementById("summaryAuthor").innerHTML    = `<b>Author:</b> ${record.Author}`;
  document.getElementById("summaryAction").innerHTML    =
    `<b>Status:</b> ${record.Status === "Loan" ? "Signed Out" : "Returned"}`;
  document.getElementById("summaryDate").innerHTML      =
    `<b>Today:</b> ${record.Status === "Loan" ? record.LoanDate : record.ReturnDate}`;

  const img = document.getElementById("summaryCover");
  if (selectedBook && selectedBook.thumbnail) {
    img.src = selectedBook.thumbnail;
    img.style.display = "block";
  } else {
    img.style.display = "none";
  }

  // AR button only on return
  document.getElementById("arButton").style.display =
    record.Status === "Return" ? "block" : "none";
}

/* ===========================================================
   ACCELERATED READER BUTTON
=========================================================== */

document.getElementById("arButton").addEventListener("click", () => {
  window.open(AR_URL, "_blank");
});

/* ===========================================================
   WHO HAS THIS BOOK? SCREEN
=========================================================== */

document.getElementById("whoHasButton").addEventListener("click", () => {
  stopCamera();
  document.getElementById("scan-screen").style.display = "none";
  document.getElementById("who-screen").style.display  = "block";
  document.getElementById("whoQueryInput").value = "";
  document.getElementById("whoResults").innerHTML = "";
});

document.getElementById("detailWhoHasButton").addEventListener("click", async () => {
  if (!selectedBook) return;
  stopCamera();
  document.getElementById("detail-screen").style.display = "none";
  document.getElementById("who-screen").style.display    = "block";
  document.getElementById("whoQueryInput").value = selectedBook.title;
  await runWhoSearch(selectedBook.title);
});

document.getElementById("whoBackButton").addEventListener("click", () => {
  document.getElementById("who-screen").style.display  = "none";
  document.getElementById("scan-screen").style.display = "block";
});

document.getElementById("whoSearchButton").addEventListener("click", async () => {
  const q = document.getElementById("whoQueryInput").value.trim();
  await runWhoSearch(q);
});

async function runWhoSearch(queryTitlePart) {
  const out = document.getElementById("whoResults");
  out.innerHTML = "";

  if (!queryTitlePart) {
    out.innerHTML = "<p>Please type part of a title.</p>";
    return;
  }

  await loadLibraryData();
  const qLower = queryTitlePart.toLowerCase();

  const matchingTitles = books
    .map(b => b.Title)
    .filter(t => (t || "").toLowerCase().includes(qLower));

  if (!matchingTitles.length) {
    out.innerHTML = "<p>No matching titles in our catalogue.</p>";
    return;
  }

  const uniqueTitles = [...new Set(matchingTitles)];
  uniqueTitles.forEach(title => {
    const borrowers = getOpenLoansForTitle(title);
    if (!borrowers.length) return;

    let html = `<div style="margin-bottom:12px;background:rgba(255,255,255,0.12);padding:10px;border-radius:10px;">`;
    html += `<p><b>${title}</b></p>`;
    borrowers.forEach(bor => {
      html += `<p style="margin:2px 0;">${bor.form} — ${bor.initials} (has ${bor.copies} copy/copies)</p>`;
    });
    html += `</div>`;
    out.innerHTML += html;
  });

  if (!out.innerHTML) {
    out.innerHTML = "<p>No copies of these titles are currently on loan.</p>";
  }
}

/* ===========================================================
   NAVIGATION BUTTONS
=========================================================== */

document.getElementById("coverButton").onclick = startCoverCapture;

document.getElementById("backToStartButton").addEventListener("click", () => {
  document.getElementById("detail-screen").style.display = "none";
  document.getElementById("scan-screen").style.display   = "block";
});

document.getElementById("summaryBackBtn").addEventListener("click", () => {
  selectedBook = null;
  pendingAction = null;
  document.getElementById("summary-screen").style.display = "none";
  document.getElementById("scan-screen").style.display    = "block";
});
</script>

</body>
</html>
