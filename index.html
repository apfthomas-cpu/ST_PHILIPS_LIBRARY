<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Library Loan System</title>

<style>
    * { box-sizing: border-box; }

    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: url('Background.jpg') no-repeat center center fixed;
        background-size: cover;
        color: white;
    }

    .overlay-box {
        background: rgba(0,0,0,0.55);
        padding: 20px;
        border-radius: 14px;
        width: 90%;
        max-width: 480px;
        margin: 20px auto;
        text-align: center;
    }

    input, select, button {
        width: 100%;
        padding: 14px;
        margin-top: 12px;
        border-radius: 10px;
        border: none;
        font-size: 18px;
    }

    button {
        cursor: pointer;
        background: #8AAA AF;
        color: white;
        font-size: 20px;
        font-weight: bold;
    }

    button:hover {
        opacity: 0.9;
    }

    #reader {
        width: 100%;
        max-width: 100%;
        height: auto;
        margin-bottom: 15px;
    }

    #summary-screen { display: none; }

    #summaryCover {
        margin-top: 12px;
        max-width: 180px;
        border-radius: 8px;
        box-shadow: 0 0 8px rgba(0,0,0,0.7);
        display: none;
    }

    @media (orientation: landscape) {
        .overlay-box { max-width: 600px; }
        input, select, button { font-size: 16px; }
    }
</style>
</head>

<body>

<!-- MAIN INPUT SCREEN -->
<div id="scan-screen" class="overlay-box">
    <h2>Library Book Loan / Return</h2>

    <div id="reader"></div>

    <input id="barcodeInput" placeholder="Or scan/type barcode here..." />

    <h3>Action</h3>
    <select id="actionSelect">
        <option value="">Choose...</option>
        <option value="loan">Loan Out</option>
        <option value="return">Return</option>
    </select>

    <h3>Form</h3>
    <select id="formSelect">
        <option value="">Choose form...</option>
        <option value="Form 8">Form 8</option>
        <option value="Form 7">Form 7</option>
        <option value="Form 6">Form 6</option>
        <option value="Form 5">Form 5</option>
        <option value="Form 4">Form 4</option>
        <option value="Form 3">Form 3</option>
    </select>

    <h3>Name (Initials)</h3>
    <select id="initialsSelect">
        <option value="">Choose initials...</option>
    </select>

    <button onclick="processScan()">Continue</button>
</div>

<!-- SUMMARY SCREEN -->
<div id="summary-screen" class="overlay-box">
    <h2>Loan Summary</h2>
    <p id="summaryForm"></p>
    <p id="summaryName"></p>
    <p id="summaryBook"></p>
    <p id="summaryAuthor"></p>
    <p id="summaryStatus"></p>
    <p id="summaryDate"></p>
    <p id="summaryLoanDate"></p>
    <p id="summaryReturnDate"></p>
    <img id="summaryCover" src="">
    <button onclick="resetForm()">Scan Another Book</button>
</div>

<!-- CAMERA SCANNER -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* -----------------------------------------
   FORM → INITIALS
----------------------------------------- */
const formStudents = {
    "Form 8": ["JC","ADB","CG","JG","RH","KH","AL","LLV","WN","IO","MP","HP","Ase","Ast","ST","AT","CW"],
    "Form 7": ["DAB","EC","TE","DE-S","PH-S","CH","NJ","LLFP","TM","LP","SS","AS","TS"],
    "Form 6": ["MA","EC","MH","PM","AP","MT"],
    "Form 5": ["PC","GH","CH","SH","EL","MM","RM","PS","OS","MT","AT","TW","BW"],
    "Form 4": ["AWAM","BC","HD","NN","ZJ","LN","PP","KP","NS","GSP","BT"],
    "Form 3": ["PA","PC","WH","BH"]
};

document.getElementById("formSelect").addEventListener("change", () => {
    const form = formSelect.value;
    initialsSelect.innerHTML = `<option value="">Choose initials...</option>`;
    if (!form) return;

    formStudents[form].forEach(i => {
        let opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${i} (${form})`;
        initialsSelect.appendChild(opt);
    });
});

/* -----------------------------------------
   CAMERA: FORCE REAR CAMERA
----------------------------------------- */
let html5QrCode;

async function startCameraScanner() {
    const cameras = await Html5Qrcode.getCameras();

    let rearCamera = cameras.find(c =>
        c.label.toLowerCase().includes("back") ||
        c.label.toLowerCase().includes("rear")
    );

    let cameraId = rearCamera ? rearCamera.id : cameras[0].id;

    html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: { width: 260, height: 160 } },
        decodedText => {
            document.getElementById("barcodeInput").value = decodedText;
            html5QrCode.stop();
        }
    );
}

window.onload = startCameraScanner;

/* -----------------------------------------
   UNIVERSAL ISBN EXTRACTOR
----------------------------------------- */
function extractISBN(raw) {
    let digits = raw.replace(/\D/g, "");

    if (digits.length >= 10 && digits.length <= 13) return digits;

    if (digits.length > 13) {
        let sub13 = digits.match(/\d{13}/);
        if (sub13) return sub13[0];

        let sub10 = digits.match(/\d{10}/);
        if (sub10) return sub10[0];
    }

    return digits;
}

/* Convert EAN-13 → ISBN-10 */
function ean13ToIsbn10(ean) {
    if (!ean.startsWith("978") && !ean.startsWith("979")) return null;

    let core = ean.substring(3, 12);
    let sum = 0;
    for (let i = 0; i < 9; i++) sum += (10 - i) * parseInt(core[i]);

    let check = 11 - (sum % 11);
    if (check === 10) check = "X";
    if (check === 11) check = "0";

    return core + check;
}

/* -----------------------------------------
   GOOGLE BOOKS LOOKUP (ROBUST)
----------------------------------------- */
async function lookupBook(rawCode) {

    let isbn = extractISBN(rawCode);
    let urls = [];

    if (isbn.length === 13) urls.push(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);

    if (isbn.length === 13) {
        let isbn10 = ean13ToIsbn10(isbn);
        if (isbn10) urls.push(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn10}`);
    }

    if (isbn.length === 10)
        urls.push(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);

    urls.push(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(rawCode)}`);

    for (let url of urls) {
        try {
            let res = await fetch(url);
            let data = await res.json();

            if (data.items) {
                let info = data.items[0].volumeInfo;
                return {
                    title: info.title || "Unknown Title",
                    author: info.authors ? info.authors[0] : "Unknown Author",
                    cover: info.imageLinks ? info.imageLinks.thumbnail : ""
                };
            }
        } catch {}
    }

    return { title: "Unknown Book", author: "Unknown Author", cover: "" };
}

/* -----------------------------------------
   PROCESS SCAN
----------------------------------------- */
let loanRecords = {};

async function processScan() {
    const raw = barcodeInput.value.trim();
    const action = actionSelect.value;
    const form = formSelect.value;
    const initials = initialsSelect.value;

    if (!raw || !action || !form || !initials) {
        alert("Fill all fields.");
        return;
    }

    const book = await lookupBook(raw);
    const today = new Date().toLocaleDateString();

    if (!loanRecords[raw]) loanRecords[raw] = {};

    if (action === "loan") loanRecords[raw].loan = today;
    if (action === "return") loanRecords[raw].return = today;

    loanRecords[raw].form = form;
    loanRecords[raw].initials = initials;

    showSummary(book, action, raw);
}

/* -----------------------------------------
   SUMMARY SCREEN
----------------------------------------- */
function showSummary(book, action, raw) {
    scan-screen.style.display = "none";
    summary-screen.style.display = "block";

    const record = loanRecords[raw];

    summaryForm.innerHTML = `<strong>Form:</strong> ${record.form}`;
    summaryName.innerHTML = `<strong>Name:</strong> ${record.initials}`;
    summaryBook.innerHTML = `<strong>Book:</strong> ${book.title}`;
    summaryAuthor.innerHTML = `<strong>Author:</strong> ${book.author}`;
    summaryStatus.innerHTML = `<strong>Status:</strong> ${action}`;
    summaryDate.innerHTML = `<strong>Today:</strong> ${new Date().toLocaleDateString()}`;
    summaryLoanDate.innerHTML = `<strong>Date Loaned:</strong> ${record.loan || "—"}`;
    summaryReturnDate.innerHTML = `<strong>Date Returned:</strong> ${record.return || "—"}`;

    if (book.cover) {
        summaryCover.src = book.cover;
        summaryCover.style.display = "block";
    } else {
        summaryCover.style.display = "none";
    }
}

/* -----------------------------------------
   RESET
----------------------------------------- */
function resetForm() {
    scan-screen.style.display = "block";
    summary-screen.style.display = "none";

    barcodeInput.value = "";
    actionSelect.value = "";
    formSelect.value = "";
    initialsSelect.innerHTML = `<option value="">Choose initials...</option>`;

    startCameraScanner();
}
</script>
</body>
</html>
