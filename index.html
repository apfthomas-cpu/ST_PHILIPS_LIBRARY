<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ST PHILIP'S LIBRARY BOOK LOAN/RETURN</title>

<!-- Styling -->
<style>
    * {
        box-sizing: border-box;
        font-family: Arial, sans-serif !important;
    }

    body {
        margin: 0;
        padding: 0;
        background: url('Background.jpg') no-repeat center center fixed;
        background-size: cover;
        color: white;
    }

    .overlay-box {
        background: rgba(0,0,0,0.55);
        padding: 20px;
        border-radius: 14px;
        width: 90%;
        max-width: 480px;
        margin: 20px auto;
        text-align: center;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    h1 {
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 20px;
        text-transform: uppercase;
        text-align: center;
    }

    button, select {
        width: 100%;
        padding: 14px;
        margin-top: 12px;
        border-radius: 10px;
        border: none;
        font-size: 18px;
        cursor: pointer;
        text-align: center;
        transition: transform 0.15s ease, opacity 0.2s ease;
    }

    button {
        background: #8AAA AF;
        color: black;
        font-weight: bold;
        text-transform: uppercase;
    }

    button:hover { transform: scale(1.03); opacity: 0.9; }
    button:active { transform: scale(0.95); }

    #reader {
        width: 100%;
        display: none;
        margin-top: 15px;
    }

    #summary-screen { display: none; }

    #summaryCover {
        max-width: 180px;
        margin-top: 15px;
        display: none;
        border-radius: 8px;
    }
</style>
</head>

<body>

<!-- MAIN SCREEN -->
<div id="scan-screen" class="overlay-box">

    <h1>ST PHILIP'S LIBRARY BOOK LOAN/RETURN</h1>

    <button id="startScanButton">SCAN BAR CODE HERE</button>

    <div id="reader"></div>

    <input type="hidden" id="barcodeInput">

    <h3>Action</h3>
    <select id="actionSelect">
        <option value="loan">Sign Out</option>
        <option value="return">Return</option>
    </select>

    <h3>Form</h3>
    <select id="formSelect">
        <option value="">Select Form…</option>
        <option value="Form 8">Form 8</option>
        <option value="Form 7">Form 7</option>
        <option value="Form 6">Form 6</option>
        <option value="Form 5">Form 5</option>
        <option value="Form 4">Form 4</option>
        <option value="Form 3">Form 3</option>
    </select>

    <h3>Initials</h3>
    <select id="initialsSelect">
        <option value="">Select Initials…</option>
    </select>

    <button id="continueButton">Continue</button>

</div>

<!-- SUMMARY SCREEN -->
<div id="summary-screen" class="overlay-box">

    <h2>Loan Summary</h2>

    <p id="summaryForm"></p>
    <p id="summaryInitials"></p>
    <p id="summaryBook"></p>
    <p id="summaryAuthor"></p>
    <p id="summaryAction"></p>
    <p id="summaryDate"></p>
    <p id="summaryLoan"></p>
    <p id="summaryReturn"></p>

    <img id="summaryCover">

    <button onclick="resetForm()">Scan Another Book</button>
</div>

<!-- CAMERA LIBRARY -->
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- MAIN SCRIPT -->
<script>
/* ----------------------------------------------------------
   FORM → INITIALS DATA
----------------------------------------------------------- */
const formStudents = {
    "Form 8": ["JC","ADB","CG","JG","RH","KH","AL","LLV","WN","IO","MP","HP","Ase","Ast","ST","AT","CW"],
    "Form 7": ["DAB","EC","TE","DE-S","PH-S","CH","NJ","LLFP","TM","LP","SS","AS","TS"],
    "Form 6": ["MA","EC","MH","PM","AP","MT"],
    "Form 5": ["PC","GH","CH","SH","EL","MM","RM","PS","OS","MT","AT","TW","BW"],
    "Form 4": ["AWAM","BC","HD","NN","ZJ","LN","PP","KP","NS","GSP","BT"],
    "Form 3": ["PA","PC","WH","BH"]
};

/* ----------------------------------------------------------
   INITIALS DROPDOWN POPULATION — CLEAN, SAFE VERSION
----------------------------------------------------------- */
document.getElementById("formSelect").addEventListener("change", function() {

    const form = this.value;
    const initialsSelect = document.getElementById("initialsSelect");

    initialsSelect.innerHTML = `<option value="">Select Initials…</option>`;

    if (!formStudents[form]) return;

    formStudents[form].forEach(initial => {
        const opt = document.createElement("option");
        opt.value = initial;
        opt.textContent = `${initial} (${form})`;
        initialsSelect.appendChild(opt);
    });
});

/* ----------------------------------------------------------
   CAMERA SCANNER — STABLE VERSION
----------------------------------------------------------- */
let html5Qr = null;

async function startScanner() {
    try {
        const cameras = await Html5Qrcode.getCameras();
        if (!cameras.length) return alert("No camera detected.");

        const rearCam = cameras.find(c =>
            c.label.toLowerCase().includes("back") ||
            c.label.toLowerCase().includes("rear")
        );
        const camId = rearCam ? rearCam.id : cameras[0].id;

        html5Qr = new Html5Qrcode("reader");

        document.getElementById("reader").style.display = "block";

        await html5Qr.start(
            camId,
            { fps: 10, qrbox: { width: 250, height: 140 } },
            text => {
                document.getElementById("barcodeInput").value = text;
                html5Qr.stop();
                document.getElementById("reader").style.display = "none";
            }
        );

    } catch (e) {
        console.error(e);
        alert("Camera cannot start. Check permissions.");
    }
}

document.getElementById("startScanButton").addEventListener("click", startScanner);

/* ----------------------------------------------------------
   ISBN CLEANER + GOOGLE LOOKUP
----------------------------------------------------------- */
function cleanISBN(raw) {
    const digits = raw.replace(/\D/g, "");
    return digits.length >= 10 ? digits : raw;
}

async function lookupBook(isbn) {
    isbn = cleanISBN(isbn);

    const url = `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`;
    try {
        const data = await (await fetch(url)).json();
        if (data.items) {
            const info = data.items[0].volumeInfo;
            return {
                title: info.title || "Unknown",
                author: info.authors?.[0] || "Unknown",
                cover: info.imageLinks?.thumbnail || ""
            };
        }
    } catch {}

    return { title: "Unknown", author: "Unknown", cover: "" };
}

/* ----------------------------------------------------------
   PROCESS LOAN
----------------------------------------------------------- */
let loanDB = {};

document.getElementById("continueButton").addEventListener("click", async function() {

    const barcode = document.getElementById("barcodeInput").value;
    const action = document.getElementById("actionSelect").value;
    const form = document.getElementById("formSelect").value;
    const initials = document.getElementById("initialsSelect").value;

    if (!barcode || !action || !form || !initials)
        return alert("Please fill in all fields and scan a book.");

    const book = await lookupBook(barcode);

    if (!loanDB[barcode]) loanDB[barcode] = {};

    const today = new Date().toLocaleDateString();

    if (action === "loan") loanDB[barcode].loan = today;
    if (action === "return") loanDB[barcode].return = today;

    loanDB[barcode].form = form;
    loanDB[barcode].initials = initials;

    // Show summary
    document.getElementById("scan-screen").style.display = "none";
    document.getElementById("summary-screen").style.display = "block";

    document.getElementById("summaryForm").innerHTML = `<b>Form:</b> ${form}`;
    document.getElementById("summaryInitials").innerHTML = `<b>Name:</b> ${initials}`;
    document.getElementById("summaryBook").innerHTML = `<b>Book:</b> ${book.title}`;
    document.getElementById("summaryAuthor").innerHTML = `<b>Author:</b> ${book.author}`;
    document.getElementById("summaryAction").innerHTML = `<b>Status:</b> ${action === "loan" ? "Signed Out" : "Returned"}`;
    document.getElementById("summaryDate").innerHTML = `<b>Date:</b> ${today}`;
    document.getElementById("summaryLoan").innerHTML = `<b>Date Loaned:</b> ${loanDB[barcode].loan || "—"}`;
    document.getElementById("summaryReturn").innerHTML = `<b>Date Returned:</b> ${loanDB[barcode].return || "—"}`;

    if (book.cover) {
        const img = document.getElementById("summaryCover");
        img.src = book.cover;
        img.style.display = "block";
    }
});

/* ----------------------------------------------------------
   RESET
----------------------------------------------------------- */
function resetForm() {
    document.getElementById("scan-screen").style.display = "block";
    document.getElementById("summary-screen").style.display = "none";

    document.getElementById("barcodeInput").value = "";
    document.getElementById("formSelect").value = "";
    document.getElementById("initialsSelect").innerHTML = `<option value="">Select Initials…</option>`;
}

</script>
</body>
</html>
